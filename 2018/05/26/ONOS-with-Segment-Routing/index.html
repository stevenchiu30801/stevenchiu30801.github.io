<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"stevenchiu30801.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="This tutorial is to run Segment Routing application in ONOS on a 2x2 leaf-spine topology built with Mininet.">
<meta property="og:type" content="article">
<meta property="og:title" content="ONOS with Segment Routing">
<meta property="og:url" content="https://stevenchiu30801.github.io/2018/05/26/ONOS-with-Segment-Routing/index.html">
<meta property="og:site_name" content="Steven&#39;s Blog">
<meta property="og:description" content="This tutorial is to run Segment Routing application in ONOS on a 2x2 leaf-spine topology built with Mininet.">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://stevenchiu30801.github.io/images/onos-with-segment-routing/topology.png">
<meta property="og:image" content="https://stevenchiu30801.github.io/images/onos-with-segment-routing/ping_result.png">
<meta property="og:image" content="https://stevenchiu30801.github.io/images/onos-with-segment-routing/labels.png">
<meta property="article:published_time" content="2018-05-26T13:09:39.000Z">
<meta property="article:modified_time" content="2021-01-12T12:05:16.313Z">
<meta property="article:author" content="Steven Chiu">
<meta property="article:tag" content="ONOS">
<meta property="article:tag" content="SDN">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://stevenchiu30801.github.io/images/onos-with-segment-routing/topology.png">

<link rel="canonical" href="https://stevenchiu30801.github.io/2018/05/26/ONOS-with-Segment-Routing/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-tw'
  };
</script>

  <title>ONOS with Segment Routing | Steven's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Steven's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-project">

    <a href="/project/" rel="section"><i class="fa fa-code fa-fw"></i>project</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="https://stevenchiu30801.github.io/2018/05/26/ONOS-with-Segment-Routing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Steven Chiu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Steven's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ONOS with Segment Routing
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-05-26 21:09:39" itemprop="dateCreated datePublished" datetime="2018-05-26T21:09:39+08:00">2018-05-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-12 20:05:16" itemprop="dateModified" datetime="2021-01-12T20:05:16+08:00">2021-01-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>This tutorial is to run Segment Routing application in ONOS on a 2x2 leaf-spine topology built with Mininet. <a id="more"></a></p>
<h2 id="Experiment-Environment"><a href="#Experiment-Environment" class="headerlink" title="Experiment Environment"></a>Experiment Environment</h2><p>I have run this test successfully on Ubuntu 16.04 with ONOS 1.12 and 1.14 two versions.</p>
<h2 id="Install-And-Run-ONOS"><a href="#Install-And-Run-ONOS" class="headerlink" title="Install And Run ONOS"></a>Install And Run ONOS</h2><p>Refer to <a href="https://wiki.onosproject.org/display/ONOS/Developer+Quick+Start" target="_blank" rel="noopener">ONOS Wiki</a>.</p>
<h3 id="Enable-Command-onos-netcfg"><a href="#Enable-Command-onos-netcfg" class="headerlink" title="Enable Command onos-netcfg"></a>Enable Command <code>onos-netcfg</code></h3><p>Source this file to use command <code>onos-netcfg</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sourc $ONOS_ROOT&#x2F;tools&#x2F;dev&#x2F;bash_profile</span><br></pre></td></tr></table></figure>

<p>Or you can simply add the line in <code>.bashrc</code>.</p>
<h3 id="Enable-ONOS-Applications"><a href="#Enable-ONOS-Applications" class="headerlink" title="Enable ONOS Applications"></a>Enable ONOS Applications</h3><p>Enable necessary applications in ONOS shell.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onos&gt; app activate drivers,openflow,netcfghostprovider,segmentrouting</span><br></pre></td></tr></table></figure>

<p>Or you can simply add the following line in <code>.bashrc</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export ONOS_APPS&#x3D;&#39;drivers,openflow,netcfghostprovider,segmentrouting&#39;</span><br></pre></td></tr></table></figure>

<h2 id="Install-Mininet"><a href="#Install-Mininet" class="headerlink" title="Install Mininet"></a>Install Mininet</h2><p>Refer to <a href="https://github.com/mininet/mininet" target="_blank" rel="noopener">Mininet Github page</a>.</p>
<h2 id="2x2-Leaf-Sping-Topology"><a href="#2x2-Leaf-Sping-Topology" class="headerlink" title="2x2 Leaf-Sping Topology"></a>2x2 Leaf-Sping Topology</h2><p>In this practice, we will run our segment routing application on 2x2 leaf-spine topology as the following picture.</p>
<center>
<img src="/images/onos-with-segment-routing/topology.png" class="">
</center>

<p>Each leaf switches are attached with two hosts. The two subnets are 10.6.1.0/24 and 10.6.2.0/24.</p>
<h2 id="ONOS-Configuration"><a href="#ONOS-Configuration" class="headerlink" title="ONOS Configuration"></a>ONOS Configuration</h2><p>We are required to configure three network elements in ONOS - devices, ports and hosts.</p>
<h3 id="Devices"><a href="#Devices" class="headerlink" title="Devices"></a>Devices</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">"devices" : &#123;</span><br><span class="line">    "of:0000000000000191" : &#123;</span><br><span class="line">        "segmentrouting" : &#123;</span><br><span class="line">            "name" : "Spine-R1",</span><br><span class="line">            "ipv4NodeSid" : 101,</span><br><span class="line">            "ipv4Loopback" : "10.6.3.254",</span><br><span class="line">            "routerMac" : "00:00:00:00:03:80",</span><br><span class="line">            "isEdgeRouter" : false,</span><br><span class="line">            "adjacencySids" : []</span><br><span class="line">        &#125;,</span><br><span class="line">        "basic" : &#123;</span><br><span class="line">            "driver" : "ofdpa-ovs"</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>To config the switches as segment routers the following settings are needed to do.</p>
<ul>
<li><code>of:0000000000000191</code>: Datapath ID (DPID) - ONOS uses this ID to configure corresponding switches.</li>
<li><code>segmentrouting</code>: Segment routing application specific parameters</li>
<li><code>name</code>: name of the switch</li>
<li><code>ipv4NodeSid</code>: Node segment ID</li>
<li><code>ipv4Lookback</code>: IP address of the loopback interface of the switch</li>
<li><code>routerMac</code>: MAC address of the loopback interface - In this implementation, this MAC address is used as src/dst MAC address in Ethernet headers for communication to other switches, instead of using the interface-MAC addresses.</li>
<li><code>isEdgeRouter</code>: The flag to determine the edge router</li>
<li><code>adjacencySids</code>: Adjacency segment ID - This is not used in this practice.</li>
<li><code>basic</code>: Basic parameters</li>
<li><code>driver</code>: Driver of the switch</li>
</ul>
<h3 id="Ports"><a href="#Ports" class="headerlink" title="Ports"></a>Ports</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">"ports" : &#123;</span><br><span class="line">    "of:0000000000000101/3" : &#123;</span><br><span class="line">        "interfaces" : [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"ips"</span> : [ <span class="string">"10.6.1.254/24"</span> ],</span><br><span class="line">                <span class="attr">"vlan-untagged"</span> : <span class="number">20</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The following is needed to configure links between segment routers and hosts.</p>
<ul>
<li><code>of:0000000000000101/3</code>: Datapath Id and the port number</li>
<li><code>ips</code>: IP of the host which is connected to the switch and it’s subnet</li>
<li><code>vlan-untagged</code>: VLAN tag number</li>
</ul>
<h3 id="Hosts"><a href="#Hosts" class="headerlink" title="Hosts"></a>Hosts</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">"hosts" : &#123;</span><br><span class="line">    "00:00:00:00:00:01/-1" : &#123;</span><br><span class="line">        "basic": &#123;</span><br><span class="line">            "ips": ["10.6.1.1"],</span><br><span class="line">            "locations": ["of:0000000000000101/3"]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The following is needed to configure hosts.</p>
<ul>
<li><code>00:00:00:00:00:01/-1</code>: Host MAC address and VLAN tag number - In this case, -1 means no VLAN tag</li>
<li><code>ips</code>: Host IP</li>
<li><code>locations</code>: The datapath and port number to which the host attaches</li>
</ul>
<p>The configuration file are shown below.</p>
<figure class="highlight json"><figcaption><span>Configuration File</span><a href="/downloads/code/onos-with-segment-routing/config.json">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="attr">"devices"</span> : {</span><br><span class="line">    <span class="attr">"of:0000000000000191"</span> : {</span><br><span class="line">      <span class="attr">"segmentrouting"</span> : {</span><br><span class="line">        <span class="attr">"name"</span> : <span class="string">"Spine-R1"</span>,</span><br><span class="line">        <span class="attr">"ipv4NodeSid"</span> : <span class="number">101</span>,</span><br><span class="line">        <span class="attr">"ipv4Loopback"</span> : <span class="string">"10.6.3.254"</span>,</span><br><span class="line">        <span class="attr">"routerMac"</span> : <span class="string">"00:00:00:00:03:80"</span>,</span><br><span class="line">        <span class="attr">"isEdgeRouter"</span> : <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">"adjacencySids"</span> : []</span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"basic"</span> : {</span><br><span class="line">        <span class="attr">"driver"</span> : <span class="string">"ofdpa-ovs"</span></span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"of:0000000000000192"</span> : {</span><br><span class="line">      <span class="attr">"segmentrouting"</span> : {</span><br><span class="line">        <span class="attr">"name"</span> : <span class="string">"Spine-R2"</span>,</span><br><span class="line">        <span class="attr">"ipv4NodeSid"</span> : <span class="number">102</span>,</span><br><span class="line">        <span class="attr">"ipv4Loopback"</span> : <span class="string">"10.6.4.254"</span>,</span><br><span class="line">        <span class="attr">"routerMac"</span> : <span class="string">"00:00:00:00:04:80"</span>,</span><br><span class="line">        <span class="attr">"isEdgeRouter"</span> : <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">"adjacencySids"</span> : []</span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"basic"</span> : {</span><br><span class="line">        <span class="attr">"driver"</span> : <span class="string">"ofdpa-ovs"</span></span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"of:0000000000000101"</span> : {</span><br><span class="line">      <span class="attr">"segmentrouting"</span> : {</span><br><span class="line">        <span class="attr">"name"</span> : <span class="string">"Leaf-R1"</span>,</span><br><span class="line">        <span class="attr">"ipv4NodeSid"</span> : <span class="number">201</span>,</span><br><span class="line">        <span class="attr">"ipv4Loopback"</span> : <span class="string">"10.6.1.254"</span>,</span><br><span class="line">        <span class="attr">"routerMac"</span> : <span class="string">"00:00:00:00:01:80"</span>,</span><br><span class="line">        <span class="attr">"isEdgeRouter"</span> : <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"adjacencySids"</span> : []</span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"basic"</span> : {</span><br><span class="line">        <span class="attr">"driver"</span> : <span class="string">"ofdpa-ovs"</span></span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"of:0000000000000102"</span> : {</span><br><span class="line">      <span class="attr">"segmentrouting"</span> : {</span><br><span class="line">        <span class="attr">"name"</span> : <span class="string">"Leaf-R2"</span>,</span><br><span class="line">        <span class="attr">"ipv4NodeSid"</span> : <span class="number">202</span>,</span><br><span class="line">        <span class="attr">"ipv4Loopback"</span> : <span class="string">"10.6.2.254"</span>,</span><br><span class="line">        <span class="attr">"routerMac"</span> : <span class="string">"00:00:00:00:02:80"</span>,</span><br><span class="line">        <span class="attr">"isEdgeRouter"</span> : <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"adjacencySids"</span> : []</span><br><span class="line">      },</span><br><span class="line">      <span class="attr">"basic"</span> : {</span><br><span class="line">        <span class="attr">"driver"</span> : <span class="string">"ofdpa-ovs"</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"ports"</span> : {</span><br><span class="line">    <span class="attr">"of:0000000000000101/3"</span> : {</span><br><span class="line">      <span class="attr">"interfaces"</span> : [{  </span><br><span class="line">        <span class="attr">"ips"</span> : [ <span class="string">"10.6.1.254/24"</span> ],</span><br><span class="line">        <span class="attr">"vlan-untagged"</span> : <span class="number">20</span></span><br><span class="line">      }]</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"of:0000000000000101/4"</span> : {</span><br><span class="line">      <span class="attr">"interfaces"</span> : [{  </span><br><span class="line">        <span class="attr">"ips"</span> : [ <span class="string">"10.6.1.254/24"</span> ],</span><br><span class="line">        <span class="attr">"vlan-untagged"</span> : <span class="number">20</span></span><br><span class="line">      }]</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"of:0000000000000102/3"</span> : {</span><br><span class="line">      <span class="attr">"interfaces"</span> : [{  </span><br><span class="line">        <span class="attr">"ips"</span> : [ <span class="string">"10.6.2.254/24"</span> ],</span><br><span class="line">        <span class="attr">"vlan-untagged"</span> : <span class="number">40</span></span><br><span class="line">      }]</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"of:0000000000000102/4"</span> : {</span><br><span class="line">      <span class="attr">"interfaces"</span> : [{  </span><br><span class="line">        <span class="attr">"ips"</span> : [ <span class="string">"10.6.2.254/24"</span> ],</span><br><span class="line">        <span class="attr">"vlan-untagged"</span> : <span class="number">40</span></span><br><span class="line">      }]</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  <span class="attr">"hosts"</span> : {</span><br><span class="line">    <span class="attr">"00:00:00:00:00:01/-1"</span> : {</span><br><span class="line">      <span class="attr">"basic"</span>: {</span><br><span class="line">        <span class="attr">"ips"</span>: [<span class="string">"10.6.1.1"</span>],</span><br><span class="line">        <span class="attr">"locations"</span>: [<span class="string">"of:0000000000000101/3"</span>]</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"00:00:00:00:00:02/-1"</span> : {</span><br><span class="line">      <span class="attr">"basic"</span>: {</span><br><span class="line">        <span class="attr">"ips"</span>: [<span class="string">"10.6.1.2"</span>],</span><br><span class="line">        <span class="attr">"locations"</span>: [<span class="string">"of:0000000000000101/4"</span>]</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"00:00:00:00:00:03/-1"</span> : {</span><br><span class="line">      <span class="attr">"basic"</span>: {</span><br><span class="line">        <span class="attr">"ips"</span>: [<span class="string">"10.6.2.1"</span>],</span><br><span class="line">        <span class="attr">"locations"</span>: [<span class="string">"of:0000000000000102/3"</span>]</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"00:00:00:00:00:04/-1"</span> : {</span><br><span class="line">      <span class="attr">"basic"</span>: {</span><br><span class="line">        <span class="attr">"ips"</span>: [<span class="string">"10.6.2.2"</span>],</span><br><span class="line">        <span class="attr">"locations"</span>: [<span class="string">"of:0000000000000102/4"</span>]</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>Load the configuration.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ onos-netcfg &lt;onos_ip&gt; &lt;config_file&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Run-Mininet"><a href="#Run-Mininet" class="headerlink" title="Run Mininet"></a>Run Mininet</h2><p>Here is the topology script to run in Mininet.</p>
<figure class="highlight py"><figcaption><span>Topology</span><a href="/downloads/code/onos-with-segment-routing/topo.py">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 2-by-2 leaf-spine topology</span></span><br><span class="line"><span class="keyword">from</span> mininet.topo <span class="keyword">import</span> Topo</span><br><span class="line"><span class="keyword">from</span> mininet.node <span class="keyword">import</span> Host</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTopo</span><span class="params">(Topo)</span>:</span></span><br><span class="line"></span><br><span class="line">    spineswitch = []</span><br><span class="line">    leafswitch = []</span><br><span class="line">    host = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># initialize topology</span></span><br><span class="line">        Topo.__init__(self)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">3</span>):</span><br><span class="line">            <span class="comment"># add spine switches</span></span><br><span class="line">            self.spineswitch.append(self.addSwitch(<span class="string">"100"</span>+str(i), dpid=<span class="string">"000000000000019"</span>+str(i)))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># add leaf switches</span></span><br><span class="line">            self.leafswitch.append(self.addSwitch(<span class="string">"200"</span>+str(i), dpid=<span class="string">"000000000000010"</span>+str(i)))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># add hosts</span></span><br><span class="line">        self.host.append(self.addHost(<span class="string">"3001"</span>, cls=IpHost, mac=<span class="string">"00:00:00:00:00:01"</span>, ip=<span class="string">"10.6.1.1/24"</span>, gateway=<span class="string">"10.6.1.254"</span>))</span><br><span class="line">        self.host.append(self.addHost(<span class="string">"3002"</span>, cls=IpHost, mac=<span class="string">"00:00:00:00:00:02"</span>, ip=<span class="string">"10.6.1.2/24"</span>, gateway=<span class="string">"10.6.1.254"</span>))</span><br><span class="line">        self.host.append(self.addHost(<span class="string">"3003"</span>, cls=IpHost, mac=<span class="string">"00:00:00:00:00:03"</span>, ip=<span class="string">"10.6.2.1/24"</span>, gateway=<span class="string">"10.6.2.254"</span>))</span><br><span class="line">        self.host.append(self.addHost(<span class="string">"3004"</span>, cls=IpHost, mac=<span class="string">"00:00:00:00:00:04"</span>, ip=<span class="string">"10.6.2.2/24"</span>, gateway=<span class="string">"10.6.2.254"</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># add links</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">            self.addLink(self.spineswitch[i], self.leafswitch[<span class="number">0</span>])</span><br><span class="line">            self.addLink(self.spineswitch[i], self.leafswitch[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">            self.addLink(self.leafswitch[i], self.host[i*<span class="number">2</span>])</span><br><span class="line">            self.addLink(self.leafswitch[i], self.host[i*<span class="number">2</span>+<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IpHost</span><span class="params">(Host)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, gateway, *args, **kwargs)</span>:</span></span><br><span class="line">        super(IpHost, self).__init__(name,*args,**kwargs)</span><br><span class="line">        self.gateway = gateway</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">config</span><span class="params">(self, **kwargs)</span>:</span></span><br><span class="line">        Host.config(self,**kwargs)</span><br><span class="line">        mtu = <span class="string">"ifconfig "</span> + self.name + <span class="string">"-eth0 mtu 1490"</span></span><br><span class="line">        self.cmd(mtu)</span><br><span class="line">        self.cmd(<span class="string">'ip route add default via %s'</span> % self.gateway)</span><br><span class="line"></span><br><span class="line">topos = {<span class="string">'mytopo'</span>: (<span class="keyword">lambda</span>: MyTopo())}</span><br></pre></td></tr></table></figure>

<p>Run Mininet.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mn --switch&#x3D;ovs,protocols&#x3D;OpenFlow13 --custom&#x3D;topo.py --topo&#x3D;mytopo --controller&#x3D;remote,127.0.0.1:6653</span><br></pre></td></tr></table></figure>

<p>Mininet will create a 2x2 leaf-spine fabric with OpenFlow1.3 enabled Open vSwitches and connect to the ONOS controller running at localhost.</p>
<h2 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h2><p>We can run <code>pingall</code> at Mininet shell and verify the connectivity between all hosts.</p>
<center>
<img src="/images/onos-with-segment-routing/ping_result.png" class="">
</center>

<h2 id="Check-OpenFlow-Table"><a href="#Check-OpenFlow-Table" class="headerlink" title="Check OpenFlow Table"></a>Check OpenFlow Table</h2><p>Check flow tables in switches.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ovs-ofctl -O OpenFlow13 dump-flows &lt;bridge&gt;</span><br></pre></td></tr></table></figure>

<p>Check group tables in switches.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ovs-ofctl -O OpenFlow13 dump-groups &lt;bridge&gt;</span><br></pre></td></tr></table></figure>

<p>See the <a href="http://www.openvswitch.org/support/dist-docs/ovs-ofctl.8.txt" target="_blank" rel="noopener">Open vSwitch Manual</a> for more details.</p>
<p>To run the commands shell Mininet shell, type the following.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mininet&gt; 2001 ovs-ofctl -O OpenFlow13 dump-flows &quot;2001&quot;</span><br></pre></td></tr></table></figure>

<p>Trace the flow tables and group tables and you can see switches push and pop MPLS labels.</p>
<p>Here are some points I got.</p>
<ul>
<li>In this practice, switches did perform segment routing using MPLS labels to route.</li>
<li>For packets crossing subnets, the leaf switch would only push MPLS labels of the egress edge switch, which was <code>ipv4NodeSid</code> we set in device configuration.</li>
<li>As the packets arrived at spine switches, MPLS labels were popped. The reason was that for this 2x2 leaf-spine fabric, spine switches were called penultimate hop and would perform labels popping to reduce the load at egress switches.</li>
<li>Since labels were popped at penultimate switches, the egress switches only needed to do IP table lookup without MPLS lookup, solving the Egress LSR Double Lookup problem.</li>
</ul>
<p>The following picture shows labels of each flow in this practice.</p>
<center>
<img src="/images/onos-with-segment-routing/labels.png" class="" width="500">
</center>

<h2 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h2><p>After tracing the flows installed by Segment Routing application, configuration for hosts is not truly necessary. Segment Routing uses flow rules to match the subnet under switches, which is already included in port configuration, but not Ethernet or IP addresses.</p>
<p>Configuration with hosts omitted has been tested and packets could be correctly forwarded.</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/ONOS/" rel="tag"># ONOS</a>
              <a href="/tags/SDN/" rel="tag"># SDN</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/04/14/Use-Open-vSwitch-as-OpenFlow-Switch/" rel="prev" title="Use Open vSwitch as OpenFlow Switch">
      <i class="fa fa-chevron-left"></i> Use Open vSwitch as OpenFlow Switch
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/02/07/SR-IOV-CNI-on-Kubernetes/" rel="next" title="SR-IOV CNI on Kubernetes">
      SR-IOV CNI on Kubernetes <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Experiment-Environment"><span class="nav-text">Experiment Environment</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Install-And-Run-ONOS"><span class="nav-text">Install And Run ONOS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Enable-Command-onos-netcfg"><span class="nav-text">Enable Command onos-netcfg</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Enable-ONOS-Applications"><span class="nav-text">Enable ONOS Applications</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Install-Mininet"><span class="nav-text">Install Mininet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2x2-Leaf-Sping-Topology"><span class="nav-text">2x2 Leaf-Sping Topology</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ONOS-Configuration"><span class="nav-text">ONOS Configuration</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Devices"><span class="nav-text">Devices</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ports"><span class="nav-text">Ports</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hosts"><span class="nav-text">Hosts</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Run-Mininet"><span class="nav-text">Run Mininet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Test"><span class="nav-text">Test</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Check-OpenFlow-Table"><span class="nav-text">Check OpenFlow Table</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Update"><span class="nav-text">Update</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Steven Chiu"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Steven Chiu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">13</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/stevenchiu30801" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;stevenchiu30801" rel="noopener" target="_blank"><i class="fab fa-2x fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:steven30801@gmail.com" title="E-Mail → mailto:steven30801@gmail.com" rel="noopener" target="_blank"><i class="fa fa-2x fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.linkedin.com/in/yi-sung-chiu-b78806149" title="LinkedIn → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;yi-sung-chiu-b78806149" rel="noopener" target="_blank"><i class="fab fa-2x fa-linkedin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.slideshare.net/YiSungChiu" title="SpeakerDeck → https:&#x2F;&#x2F;www.slideshare.net&#x2F;YiSungChiu" rel="noopener" target="_blank"><i class="fab fa-2x fa-slideshare fa-fw"></i></a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Steven Chiu</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
